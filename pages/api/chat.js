// ... (保留文件顶部的导入和配置) ...

export default async function handler(req, res) {
  // ... (保留请求方法检查和变量解构) ...
  
  // ... (保留用户消息保存逻辑) ...

  // ... (保留 AI 条件回复判断逻辑) ...

    // ----------------------------------------------------
    // 以下逻辑只在 AI 被 @ 时执行
    // ----------------------------------------------------

    // 3. 获取历史消息（最多 N 条）
    // ... (保留历史消息获取逻辑) ...

    // 4. 构建 Kimi Chat API 所需的消息格式
    
    // ****** 核心修改区域：调整系统提示 ******
    const systemPrompt = `
        你是一个专业的旅行规划AI，你的名字是“${aiRole}”。
        你的任务是根据用户的需求，为他们提供旅行建议、行程规划或回答相关问题。

        **你的回复必须遵循以下格式规范：**
        1.  使用 **Markdown** 格式进行回复。
        2.  使用 **标题 (#)** 来组织不同的主题或日期（例如：'## 推荐行程' 或 '### 第1天'）。
        3.  使用 **粗体 (\*\*\*)** 来强调地点、关键时间或重要信息。
        4.  使用 **列表 (\*)** 来清晰地列出选项、景点或步骤。
        5.  保持回复内容简洁、专业、优雅。
    `;
    // ***************************************

    const messagesForApi = historyMessages.reverse().map(msg => ({
      role: msg.role === 'user' ? 'user' : 'assistant',
      content: msg.message,
    }));
// ... (保留其余逻辑) ...